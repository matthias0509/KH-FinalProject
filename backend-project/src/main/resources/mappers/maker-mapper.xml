<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.foodding.maker.model.dao.MakerDao">

    <select id="selectSellerNo" resultType="int">
        SELECT SELLER_NO FROM SELLER_PROFILE WHERE USER_NO = #{userNo}
    </select>

    <select id="countFollowers" resultType="int">
        SELECT COUNT(*) FROM "FOLLOW" WHERE SELLER_NO = #{sellerNo}
    </select>

    <select id="countTempProjects" resultType="int">
        SELECT COUNT(*) 
        FROM TEMPORARY T
        WHERE T.SELLER_NO = #{sellerNo}

        AND NOT EXISTS (
            SELECT 1 
            FROM PRODUCT P
            JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
            WHERE S.SELLER_NO = T.SELLER_NO
              AND P.PRODUCT_TITLE = T.TEMP_TITLE
        )
    </select>

    <select id="selectProjectStatusCounts" resultType="map">
        SELECT 
            COUNT(CASE WHEN PRODUCT_YN = 'N' THEN 1 END) AS "reviewing",
            COUNT(CASE WHEN PRODUCT_YN = 'Y' AND PRODUCT_STATUS = 'OPEN' THEN 1 END) AS "progress",
            COUNT(CASE WHEN PRODUCT_STATUS IN ('SUCCESS', 'FAIL', 'CLOSE') THEN 1 END) AS "ended",
            COUNT(*) AS "total"
        FROM PRODUCT
        WHERE SELLER_NO = #{sellerNo}
    </select>

    <select id="selectRecentProjects" resultType="map">
        SELECT * FROM (
            SELECT 
                PRODUCT_NO AS "id",
                PRODUCT_TITLE AS "title",
                CATEGORY AS "category",
                CASE 
                    WHEN PRODUCT_YN = 'N' THEN 'REVIEW'
                    WHEN PRODUCT_STATUS = 'OPEN' THEN 'OPEN'
                    ELSE 'END'
                END AS "status",
                TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') AS "date"
            FROM PRODUCT
            WHERE SELLER_NO = #{sellerNo}
            ORDER BY CREATE_DATE DESC
        )
        WHERE ROWNUM &lt;= 5
    </select>
    
<select id="selectTempProjectList" resultType="map">
        SELECT 
            T.TEMP_NO AS "id",
            NVL(T.TEMP_TITLE, '제목 없음') AS "title",
            NVL(T.CATEGORY, '미정') AS "category",
            'draft' AS "status",
            '펀딩' AS "type",
            0 AS "reward",
            0 AS "backers",
            NVL(T.ORIGIN_THUMBNAIL, '') AS "thumbnail"
        FROM TEMPORARY T
        WHERE T.SELLER_NO = #{sellerNo}
        
        AND NOT EXISTS (
            SELECT 1 
            FROM PRODUCT P
            JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
            WHERE S.SELLER_NO = T.SELLER_NO
              AND P.PRODUCT_TITLE = T.TEMP_TITLE
        )
        
        ORDER BY T.UPDATE_DATE DESC
    </select>

    <select id="selectProductListByStatus" resultType="map">
        SELECT 
            P.PRODUCT_NO AS "id",
            P.PRODUCT_TITLE AS "title",
            P.CATEGORY AS "category",
            CASE 
                WHEN P.PRODUCT_STATUS = 'OPEN' THEN 'open'
                ELSE 'closed'
            END AS "status",
            '펀딩' AS "type",
            P.CURRENT_AMOUNT AS "reward",
            (SELECT COUNT(*) FROM ORDERS O 
             JOIN ORDER_DETAIL OD ON O.ORDER_NO = OD.ORDER_NO 
             JOIN TB_OPTION OPT ON OD.OPTION_NO = OPT.OPTION_NO 
             WHERE OPT.PRODUCT_NO = P.PRODUCT_NO) AS "backers",
            
            NVL(P.MODIFY_THUMBNAIL, P.ORIGIN_THUMBNAIL) AS "thumbnail"
            
        FROM PRODUCT P
        WHERE P.SELLER_NO = #{sellerNo}
        <if test="status == 'open'">
            AND P.PRODUCT_STATUS = 'OPEN'
        </if>
        <if test="status == 'closed'">
            AND P.PRODUCT_STATUS IN ('CLOSE', 'SUCCESS', 'FAIL')
        </if>
        ORDER BY P.CREATE_DATE DESC
    </select>
    
    <select id="selectSettlementList" resultType="map">
        SELECT 
            P.PRODUCT_NO AS "id",
            P.PRODUCT_TITLE AS "title",
            P.CURRENT_AMOUNT AS "amount", 
            TO_CHAR(P.FUND_END_DATE, 'YYYY.MM.DD') AS "projectEndDate",
            CASE 
                WHEN P.PRODUCT_STATUS = 'SUCCESS' THEN 'paid'
                WHEN P.PRODUCT_STATUS = 'OPEN' THEN 'pending'
                WHEN P.PRODUCT_STATUS IN ('FAIL', 'CLOSE') THEN 'canceled'
                ELSE 'pending'
            END AS "status",
            TO_CHAR(P.FUND_END_DATE + 7, 'YYYY.MM.DD') AS "paidDate"
        FROM PRODUCT P
        WHERE P.SELLER_NO = #{sellerNo}
        ORDER BY P.FUND_END_DATE DESC
    </select>
    
    <!-- 특정 판매자의 기본 정보 조회 -->
    <select id="selectSellerInfo" resultType="map">
        SELECT 
            M.USER_NO AS "userNo",
            M.USER_NAME AS "userName",
            M.NICKNAME AS "nickname",
            M.MODIFY_PROFILE AS "modifyProfile",
            SP.INTRODUCTION AS "introduction",
            M.EMAIL AS "email",
            M.PHONE AS "phone"
        FROM TB_USER M
        JOIN SELLER_PROFILE SP ON M.USER_NO = SP.USER_NO
        WHERE M.USER_NO = #{sellerNo}
          AND M.USER_ROLE = 'MAKER'
          AND M.USER_YN = 'N'
    </select>

    <!-- 특정 판매자의 통계 조회 (프로젝트 수, 팔로워 수) -->
    <select id="selectSellerStats" resultType="map">
        SELECT 
            (SELECT COUNT(*) 
             FROM PRODUCT 
             WHERE SELLER_NO = (SELECT SELLER_NO FROM SELLER_PROFILE WHERE USER_NO = #{sellerNo})
               AND PRODUCT_YN = 'Y'
               AND PRODUCT_STATUS IN ('OPEN', 'SUCCESS', 'FAIL', 'CLOSE')
            ) AS "projectCount",
            (SELECT COUNT(*) 
             FROM "FOLLOW" 
             WHERE SELLER_NO = (SELECT SELLER_NO FROM SELLER_PROFILE WHERE USER_NO = #{sellerNo})
            ) AS "followerCount"
        FROM DUAL
    </select>

    <!--  특정 판매자의 공개 프로젝트 목록 조회 -->
    <select id="selectSellerPublicProjects" resultType="map">
        SELECT * FROM (
            SELECT 
                P.PRODUCT_NO AS "projectNo",
                P.PRODUCT_NO AS "id",
                P.PRODUCT_TITLE AS "title",
                P.CATEGORY AS "category",
                CASE 
                    WHEN P.PRODUCT_STATUS = 'OPEN' THEN 'OPEN'
                    ELSE 'END'
                END AS "status",
                TO_CHAR(P.CREATE_DATE, 'YYYY-MM-DD') AS "date",
                P.MODIFY_THUMBNAIL AS "thumbnail"
            FROM PRODUCT P
            WHERE P.SELLER_NO = (SELECT SELLER_NO FROM SELLER_PROFILE WHERE USER_NO = #{sellerNo})
              AND P.PRODUCT_YN = 'Y'
              AND P.PRODUCT_STATUS IN ('OPEN', 'SUCCESS', 'FAIL', 'CLOSE')
            ORDER BY P.CREATE_DATE DESC
        )
        WHERE ROWNUM &lt;= 10
    </select>
    
    <!-- 판매자의 공개 프로젝트 총 개수 조회 -->
	<select id="countSellerPublicProjects" parameterType="int" resultType="int">
	    SELECT COUNT(*)
	    FROM PRODUCT
	    WHERE SELLER_NO = #{sellerNo}
	      AND PRODUCT_YN = 'Y'
	      AND PRODUCT_STATUS IN ('OPEN', 'SUCCESS', 'FAIL', 'CLOSE')
	</select>
	
	<!-- 판매자의 공개 프로젝트 목록 조회 (페이징) -->
	<select id="selectSellerPublicProjectsWithPaging" resultType="map">
	    SELECT * FROM (
	        SELECT 
	            A.*,
	            ROWNUM AS RNUM
	        FROM (
	            SELECT 
	                PRODUCT_NO as "projectNo",
	                PRODUCT_NO as "id",
	                CATEGORY as "category",
	                PRODUCT_TITLE as "title",
	                PRODUCT_STATUS as "status",
	                TO_CHAR(CREATE_DATE, 'YYYY-MM-DD') as "date",
	                MODIFY_THUMBNAIL as "thumbnail"
	            FROM PRODUCT
	            WHERE SELLER_NO = (SELECT SELLER_NO FROM SELLER_PROFILE WHERE USER_NO = #{sellerNo})
	              AND PRODUCT_YN = 'Y'
	              AND PRODUCT_STATUS IN ('OPEN', 'SUCCESS', 'FAIL', 'CLOSE')
	            ORDER BY CREATE_DATE DESC
	        )  A
	        WHERE ROWNUM <![CDATA[<=]]> (#{offset} + #{size})
	    )
	    WHERE RNUM <![CDATA[>]]> #{offset}
	</select>
	
	
	<delete id="deleteTempProject" parameterType="int">
	    DELETE FROM TEMPORARY 
	    WHERE TEMP_NO = #{tempNo}
	</delete>

</mapper>
