<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="projectMapper">

    <resultMap id="projectResultMap" type="com.kh.foodding.createProject.model.vo.Project">
        <id property="tempNo" column="tempNo" />
        <result property="title" column="title" />
        <result property="summary" column="summary" />
        <result property="targetAmount" column="TARGET_AMOUNT" />
        <result property="fundStartDate" column="FUND_START_DATE" />
        <result property="fundEndDate" column="FUND_END_DATE" />
        <result property="category" column="CATEGORY" />
        <result property="thumbnailUrl" column="thumbnailUrl" />
        <result property="shipStartDate" column="SHIP_START_DATE" />
        <association property="content" javaType="com.kh.foodding.createProject.model.vo.EditorContent">
            <result property="html" column="TEMP_STORY_HTML" />
            <result property="json" column="TEMP_STORY_JSON" />
        </association>
    </resultMap>

    <resultMap id="productDetailResultMap" type="com.kh.foodding.project.model.vo.ProjectList">
        <id property="productNo" column="PRODUCT_NO" />
        <result property="productTitle" column="PRODUCT_TITLE" />
        <result property="productDesc" column="PRODUCT_DESC" />
        <result property="storyHtml" column="STORY_HTML" />
        <result property="storyJson" column="STORY_JSON" />
        <result property="targetAmount" column="TARGET_AMOUNT" />
        <result property="currentAmount" column="CURRENT_AMOUNT" />
        <result property="fundStartDate" column="FUND_START_DATE" />
        <result property="fundEndDate" column="FUND_END_DATE" />
        <result property="shipStartDate" column="SHIP_START_DATE" />
        <result property="productStatus" column="PRODUCT_STATUS" />
        <result property="category" column="CATEGORY" />
        <result property="originThumbnail" column="ORIGIN_THUMBNAIL" />
        <result property="modifyThumbnail" column="MODIFY_THUMBNAIL" />
        <result property="createDate" column="CREATE_DATE" />
        <result property="productYn" column="PRODUCT_YN" />
        <result property="sellerNo" column="SELLER_NO" />
        
        <association property="sellerProfile" javaType="com.kh.foodding.project.model.vo.SellerProfile">
            <result property="sellerNo" column="SELLER_PROFILE_NO" />
            <result property="userNo" column="SELLER_USER_NO" />
            <result property="nickname" column="SELLER_NICKNAME" />
            <result property="email" column="SELLER_EMAIL" />
            <result property="phone" column="SELLER_PHONE" />
            <result property="introduction" column="INTRODUCTION" />
            <result property="profileImage" column="SELLER_PROFILE_IMAGE" />
        </association>
    </resultMap>

    <insert id="insertProject" parameterType="project">
    <selectKey resultType="long" keyProperty="productNo" order="BEFORE">
        SELECT SEQ_PRODUCT_NO.NEXTVAL FROM DUAL
    </selectKey>
	    INSERT INTO PRODUCT (
	        PRODUCT_NO, PRODUCT_TITLE, PRODUCT_DESC, STORY_HTML, STORY_JSON,
	        TARGET_AMOUNT, CURRENT_AMOUNT, FUND_START_DATE, FUND_END_DATE,
	        SHIP_START_DATE, CATEGORY, ORIGIN_THUMBNAIL, SELLER_NO,
	        PRODUCT_STATUS  ) VALUES (
	        #{productNo}, #{title}, #{summary}, #{content.html}, #{content.json},
	        #{targetAmount}, NVL(#{currentAmount}, 0), #{fundStartDate}, #{fundEndDate},
	        #{shipStartDate}, #{category}, NVL(#{thumbnailUrl}, 'DEFAULT_THUMBNAIL.png'),
	        #{sellerNo},
	        'WAITING'       )
	</insert>

    <insert id="insertProductOption" parameterType="map">
        INSERT INTO TB_OPTION (
            OPTION_NO, PRODUCT_NO, OPTION_NAME, OPTION_CONTENT, OPTION_PRICE
        ) VALUES (
            SEQ_OPTION_NO.NEXTVAL, #{productNo}, #{title}, #{description}, #{price}
        )
    </insert>

    <insert id="imsiProject" parameterType="project">
        <selectKey resultType="long" keyProperty="tempNo" order="BEFORE">
            SELECT SEQ_TEMP_NO.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO TEMPORARY (
            TEMP_NO, TEMP_TITLE, TEMP_DESC, TARGET_AMOUNT,
            FUND_START_DATE, FUND_END_DATE, SHIP_START_DATE, CATEGORY,
            ORIGIN_THUMBNAIL, TEMP_STORY_HTML, TEMP_STORY_JSON, 
            SELLER_NO ) VALUES (
            #{tempNo}, #{title}, #{summary}, #{targetAmount},
            #{fundStartDate}, #{fundEndDate}, #{shipStartDate}, #{category},
            NVL(#{thumbnailUrl}, 'DEFAULT_THUMBNAIL.png'), #{content.html}, #{content.json},
            #{sellerNo} )
    </insert>

    <insert id="insertTempOption" parameterType="map">
        INSERT INTO TEMP_OPTION (
            OPTION_NO, TEMP_NO, OPTION_NAME, OPTION_CONTENT, OPTION_PRICE
        ) VALUES (
            SEQ_TEMP_OPTION_NO.NEXTVAL, #{tempNo}, #{title}, #{description}, #{price}
        )
    </insert>

    <select id="selectProject" parameterType="map" resultMap="projectResultMap">
        SELECT
            TEMP_NO      AS tempNo,
            TEMP_TITLE   AS title,
            TEMP_DESC    AS summary,
            TARGET_AMOUNT,
            FUND_START_DATE,
            FUND_END_DATE,
            CATEGORY,
            ORIGIN_THUMBNAIL AS thumbnailUrl,
            SHIP_START_DATE,
            TEMP_STORY_HTML,
            TEMP_STORY_JSON
        FROM TEMPORARY
        WHERE TEMP_STATUS = 'Y' 
          AND SELLER_NO = #{sellerNo} ORDER BY TEMP_NO DESC
    </select>

    <select id="selectProjectById" parameterType="map" resultMap="projectResultMap">
        SELECT
            T.TEMP_NO      AS tempNo,
            T.TEMP_TITLE   AS title,
            T.TEMP_DESC    AS summary,
            T.TARGET_AMOUNT,
            T.FUND_START_DATE,
            T.FUND_END_DATE,
            T.CATEGORY,
            T.ORIGIN_THUMBNAIL AS thumbnailUrl,
            T.SHIP_START_DATE,
            T.TEMP_STORY_HTML,
            T.TEMP_STORY_JSON,
            SP.INTRODUCTION,
            U.USER_NO AS SELLER_USER_NO,
            U.NICKNAME AS SELLER_NICKNAME,
            U.EMAIL AS SELLER_EMAIL,
            U.PHONE AS SELLER_PHONE,
            U.MODIFY_PROFILE AS SELLER_PROFILE_IMAGE
        FROM TEMPORARY T
        LEFT JOIN SELLER_PROFILE SP ON SP.SELLER_NO = T.SELLER_NO 
        LEFT JOIN TB_USER U ON U.USER_NO = SP.USER_NO
        WHERE T.TEMP_NO = #{tempNo}
          AND T.SELLER_NO = #{sellerNo} </select>

    <select id="selectTempOptions" parameterType="long" resultType="com.kh.foodding.createProject.model.vo.Project$Reward">
        SELECT
            OPTION_NAME AS title,
            OPTION_PRICE AS price,
            OPTION_CONTENT AS description
        FROM TEMP_OPTION
        WHERE TEMP_NO = #{tempNo}
        ORDER BY OPTION_NO
    </select>

    <update id="updateDraft" parameterType="project">
        UPDATE TEMPORARY
            SET TEMP_TITLE = #{title},
                TEMP_DESC = #{summary},
                TARGET_AMOUNT = #{targetAmount},
                FUND_START_DATE = #{fundStartDate},
                FUND_END_DATE = #{fundEndDate},
                CATEGORY = #{category},
                ORIGIN_THUMBNAIL = NVL(#{thumbnailUrl}, 'DEFAULT_THUMBNAIL.png'),
                SHIP_START_DATE = #{shipStartDate},
                TEMP_STORY_HTML = #{content.html},
                TEMP_STORY_JSON = #{content.json},
                UPDATE_DATE = SYSDATE
        WHERE TEMP_NO = #{tempNo}
          AND SELLER_NO = #{sellerNo} </update>

    <delete id="deleteProject" parameterType="map">
    DELETE FROM TEMPORARY 
    WHERE TEMP_NO = #{tempNo}
      AND SELLER_NO = #{sellerNo}
</delete>

    <delete id="deleteTempOptions" parameterType="long">
        DELETE FROM TEMP_OPTION WHERE TEMP_NO = #{tempNo}
    </delete>

    <delete id="deleteProductOptions" parameterType="long">
        DELETE FROM TB_OPTION WHERE PRODUCT_NO = #{productNo}
    </delete>

    <select id="selectProjectDetail" parameterType="long" resultMap="productDetailResultMap">
        SELECT
            P.PRODUCT_NO, P.PRODUCT_TITLE, P.PRODUCT_DESC, P.STORY_HTML, P.STORY_JSON,
            P.TARGET_AMOUNT, P.CURRENT_AMOUNT, P.FUND_START_DATE, P.FUND_END_DATE,
            P.SHIP_START_DATE, P.PRODUCT_STATUS, P.CATEGORY,
            P.ORIGIN_THUMBNAIL, P.MODIFY_THUMBNAIL, P.CREATE_DATE, P.PRODUCT_YN,
            P.SELLER_NO,
            SP.SELLER_NO AS SELLER_PROFILE_NO,
            SP.USER_NO AS SELLER_USER_NO,
            SP.INTRODUCTION,
            U.NICKNAME AS SELLER_NICKNAME,
            U.EMAIL AS SELLER_EMAIL,
            U.PHONE AS SELLER_PHONE,
            U.MODIFY_PROFILE AS SELLER_PROFILE_IMAGE
        FROM PRODUCT P
        LEFT JOIN SELLER_PROFILE SP ON P.SELLER_NO = SP.SELLER_NO
        LEFT JOIN TB_USER U ON SP.USER_NO = U.USER_NO
        WHERE P.PRODUCT_NO = #{productNo}
          AND P.PRODUCT_YN = 'Y'
    </select>

</mapper>
