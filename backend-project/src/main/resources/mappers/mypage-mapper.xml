<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.foodding.mypage.model.dao.MyPageDao">

   <select id="selectMemberById" resultType="com.kh.foodding.mypage.model.vo.MyPage">
        SELECT 
            USER_NO as userNo,
            USER_ID as userId,
            USER_NAME as userName,      
            NICKNAME as nickname,
            EMAIL as email,
            PHONE as phone,
            MODIFY_PROFILE as modifyProfile, 
            POSTCODE as postcode,
            MAIN_ADDRESS as mainAddress,
            DETAIL_ADDRESS as detailAddress,
            USER_ROLE as userRole
        FROM TB_USER
        WHERE USER_ID = #{userId}
    </select>
    
    <select id="selectHashedPassword" resultType="string">
        SELECT USER_PWD 
        FROM TB_USER
        WHERE USER_ID = #{userId}
    </select>
    
    <update id="updatePassword">
        UPDATE TB_USER
        SET USER_PWD = #{newPassword}
        WHERE USER_ID = #{userId}
    </update>
        
    <update id="updateMemberInfo" parameterType="com.kh.foodding.mypage.model.vo.MyPage">
        UPDATE TB_USER
        <set>
            <if test="userName != null">USER_NAME = #{userName},</if>
            <if test="nickname != null">NICKNAME = #{nickname},</if>
            <if test="postcode != null">POSTCODE = #{postcode},</if>
            <if test="mainAddress != null">MAIN_ADDRESS = #{mainAddress},</if>
            <if test="detailAddress != null">DETAIL_ADDRESS = #{detailAddress},</if>
        </set>
        WHERE USER_ID = #{userId}
    </update>

    <update id="updateProfileImage">
        UPDATE TB_USER
        SET MODIFY_PROFILE = #{modifyProfile} 
        WHERE USER_ID = #{userId}
    </update>
    
    <update id="updateEmail">
        UPDATE TB_USER
        SET EMAIL = #{newEmail}
        WHERE USER_ID = #{userId}
    </update>
    
    <update id="updatePhone">
        UPDATE TB_USER
        SET PHONE = #{newPhone}
        WHERE USER_ID = #{userId}
    </update>

    <delete id="deleteMember">
        DELETE FROM TB_USER 
        WHERE USER_ID = #{userId}
    </delete>
    
    <select id="selectMyPageStats" resultType="map">
        SELECT 
            (SELECT COUNT(*) FROM TB_LIKE WHERE USER_NO = #{userNo}) AS "likedCount",
            (SELECT COUNT(*) FROM "FOLLOW" WHERE "FOLLOWING" = #{userNo}) AS "followingCount",
            (SELECT COUNT(*) FROM ORDERS WHERE USER_NO = #{userNo}) AS "fundingCount"
        FROM DUAL
    </select>
    
    <select id="selectLikedProjects" resultType="com.kh.foodding.mypage.model.vo.LikedProject">
        SELECT 
            P.PRODUCT_NO AS productNo,
            P.PRODUCT_TITLE AS productTitle,
            P.MODIFY_THUMBNAIL AS thumbnail,
            P.ORIGIN_THUMBNAIL AS originThumbnail,
            U.NICKNAME AS sellerName,
            TRUNC((P.CURRENT_AMOUNT / NULLIF(P.TARGET_AMOUNT, 0)) * 100) AS fundingPercent
        FROM TB_LIKE L
        JOIN PRODUCT P ON L.PRODUCT_NO = P.PRODUCT_NO
        JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
        JOIN TB_USER U ON S.USER_NO = U.USER_NO
        WHERE L.USER_NO = #{userNo}
        ORDER BY L.PRODUCT_NO DESC
    </select>
    
   <select id="selectFundingHistory" resultType="com.kh.foodding.mypage.model.vo.FundingHistory">
        SELECT 
            O.ORDER_NO AS orderNo,
            TO_CHAR(O.ORDER_DATE, 'YYYY.MM.DD') AS fundingDate,
            P.PRODUCT_TITLE AS projectTitle,
            U.NICKNAME AS makerName,
            O.ORDER_AMOUNT AS totalAmount,
            O.ORDER_STATUS AS fundingStatus,
            P.MODIFY_THUMBNAIL AS projectThumb,
            P.ORIGIN_THUMBNAIL AS originThumbnail,
            P.PRODUCT_NO AS productNo
        FROM ORDERS O
        JOIN ORDER_DETAIL OD ON O.ORDER_NO = OD.ORDER_NO
        JOIN TB_OPTION OPT ON OD.OPTION_NO = OPT.OPTION_NO 
        JOIN PRODUCT P ON OPT.PRODUCT_NO = P.PRODUCT_NO
        JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
        JOIN TB_USER U ON S.USER_NO = U.USER_NO
        WHERE O.USER_NO = #{userNo}
          AND ORDER_STATUS = 'PAY'
        ORDER BY O.ORDER_DATE DESC
    </select>
    
   <select id="selectFollowList" resultType="com.kh.foodding.mypage.model.vo.FollowedSeller">
        SELECT 
            S.SELLER_NO AS sellerNo,
            U.NICKNAME AS sellerName,
            NVL(S.INTRODUCTION, 'ÏÜåÍ∞úÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.') AS sellerBio,
            U.MODIFY_PROFILE AS sellerImage
        FROM "FOLLOW" F
        JOIN SELLER_PROFILE S ON F.SELLER_NO = S.SELLER_NO
        JOIN TB_USER U ON S.USER_NO = U.USER_NO
        WHERE F."FOLLOWING" = #{userNo}
        ORDER BY F.SELLER_NO DESC
    </select>
    
    <select id="selectFundingDetail" resultType="map">
        SELECT 
            o.ORDER_NO AS "orderNo",
            TO_CHAR(o.ORDER_DATE, 'YYYY-MM-DD HH24:MI:SS') AS "orderDate",
            o.ORDER_STATUS AS "orderStatus",
            o.DELIVERY_STATUS AS "deliveryStatus",
            o.ORDER_AMOUNT AS "totalAmount",
            o.POSTCODE AS "postcode",
            o.ADDRESS AS "address",
            
            p.PRODUCT_NO AS "productNo",
            p.PRODUCT_TITLE AS "projectTitle",
            p.MODIFY_THUMBNAIL AS "projectThumb",
            p.ORIGIN_THUMBNAIL AS "originThumbnail",
            u.NICKNAME AS "makerName", 
            
            opt.OPTION_NO AS "optionNo",
            opt.OPTION_NAME AS "rewardName",
            opt.OPTION_PRICE AS "rewardPrice",
            od.QUANTITY AS "quantity",
            
            -- TB_OPTION ÌÖåÏù¥Î∏îÏóê DELIVERY_FEE Ïª¨ÎüºÏù¥ ÏóÜÎã§Î©¥ 3000ÏúºÎ°ú Í≥†Ï†ïÌïòÍ±∞ÎÇò Ïª¨Îüº Ï∂îÍ∞Ä ÌïÑÏöî
            -- ÌòÑÏû¨ Ïä§ÌÇ§ÎßàÏóêÎäî ÏóÜÏúºÎØÄÎ°ú ÏûÑÏãúÎ°ú 3000Ïõê Í≥†Ï†ï (Ï∂îÌõÑ ÏàòÏ†ï)
            3000 AS "shippingFee"
            
        FROM ORDERS o
        JOIN ORDER_DETAIL od ON o.ORDER_NO = od.ORDER_NO
        JOIN TB_OPTION opt ON od.OPTION_NO = opt.OPTION_NO
        JOIN PRODUCT p ON opt.PRODUCT_NO = p.PRODUCT_NO
        JOIN SELLER_PROFILE s ON p.SELLER_NO = s.SELLER_NO
        JOIN TB_USER u ON s.USER_NO = u.USER_NO
        
        WHERE o.ORDER_NO = #{orderNo}
          AND o.USER_NO = #{userNo} 
    </select>
    
    <update id="updateOrderStatusToCancel">
        UPDATE ORDERS
        SET ORDER_STATUS = 'CANCLE'
        WHERE ORDER_NO = #{orderNo}
          AND USER_NO = #{userNo}
          AND ORDER_STATUS = 'PAY' -- Í≤∞Ï†ú ÏôÑÎ£å ÏÉÅÌÉúÏùº ÎïåÎßå Ï∑®ÏÜå Í∞ÄÎä•
    </update>

    <update id="updateProductAmountDecrease">
        UPDATE PRODUCT P
        SET P.CURRENT_AMOUNT = P.CURRENT_AMOUNT - (
            SELECT ORDER_AMOUNT FROM ORDERS WHERE ORDER_NO = #{orderNo}
        )
        WHERE P.PRODUCT_NO = (
            SELECT OPT.PRODUCT_NO
            FROM ORDERS O
            JOIN ORDER_DETAIL OD ON O.ORDER_NO = OD.ORDER_NO
            JOIN TB_OPTION OPT ON OD.OPTION_NO = OPT.OPTION_NO
            WHERE O.ORDER_NO = #{orderNo}
            AND ROWNUM = 1 -- ÌòπÏãú Î™®Î•º Ï§ëÎ≥µ Î∞©ÏßÄ
        )
    </update>
    <select id="selectCanceledFundingHistory" resultType="com.kh.foodding.mypage.model.vo.FundingHistory">
        SELECT 
            O.ORDER_NO AS orderNo,
            TO_CHAR(O.ORDER_DATE, 'YYYY.MM.DD') AS fundingDate,
            P.PRODUCT_TITLE AS projectTitle,
            U.NICKNAME AS makerName,
            O.ORDER_AMOUNT AS totalAmount,
            O.ORDER_STATUS AS fundingStatus,
            P.MODIFY_THUMBNAIL AS projectThumb,
            P.ORIGIN_THUMBNAIL AS originThumbnail,
            P.PRODUCT_NO AS productNo
        FROM ORDERS O
        JOIN ORDER_DETAIL OD ON O.ORDER_NO = OD.ORDER_NO
        JOIN TB_OPTION OPT ON OD.OPTION_NO = OPT.OPTION_NO
        JOIN PRODUCT P ON OPT.PRODUCT_NO = P.PRODUCT_NO
        JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
        JOIN TB_USER U ON S.USER_NO = U.USER_NO
        WHERE O.USER_NO = #{userNo}
          AND O.ORDER_STATUS = 'CANCLE'  -- üö® Ï∑®ÏÜåÎêú Í±¥Îßå Ï°∞Ìöå
        ORDER BY O.ORDER_DATE DESC
    </select>
</mapper>
