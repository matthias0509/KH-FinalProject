<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kh.foodding.admin.model.dao.ProjectManagementDao">

    <resultMap id="managementProjectMap" type="com.kh.foodding.admin.model.vo.AdminProject">
        <id property="productNo" column="PRODUCT_NO"/>
        <result property="category" column="CATEGORY"/> 
        <result property="productTitle" column="PRODUCT_TITLE"/>
        <result property="sellerName" column="MAKER_NAME"/> 
        <result property="sellerId" column="MAKER_ID"/>
        <result property="targetAmount" column="TARGET_AMOUNT"/>
        <result property="currentAmount" column="CURRENT_AMOUNT"/>
        <result property="achieveRate" column="ACHIEVE_RATE"/>
        <result property="fundStartDate" column="START_DATE"/>
        <result property="fundEndDate" column="END_DATE"/>
        <result property="productStatus" column="PRODUCT_STATUS"/>
        <result property="thumbnailUrl" column="MODIFY_THUMBNAIL"/>
    </resultMap>

    <sql id="manageSearchCriteria">
        <where>
            <choose>
                <when test="status == null or status == '' or status == 'all'">
                    AND P.PRODUCT_STATUS != 'WAITING'
                </when>
                <otherwise>
                    AND P.PRODUCT_STATUS = #{status}
                </otherwise>
            </choose>
            
            <if test="category != null and category != '' and category != 'all'">
                AND P.CATEGORY = #{category}
            </if>
            
            <if test="keyword != null and keyword != ''">
                AND (
                    P.PRODUCT_TITLE LIKE '%' || #{keyword} || '%'
                    OR U.NICKNAME LIKE '%' || #{keyword} || '%'
                    OR U.USER_ID LIKE '%' || #{keyword} || '%'
                )
            </if>
        </where>
    </sql>

    <select id="selectTotalCount" parameterType="hashmap" resultType="int">
        SELECT COUNT(*)
        FROM PRODUCT P
        JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
        JOIN TB_USER U ON S.USER_NO = U.USER_NO
        <include refid="manageSearchCriteria"/>
    </select>

    <select id="selectManagementList" parameterType="hashmap" resultMap="managementProjectMap">
        SELECT * FROM (
            SELECT ROWNUM AS RNUM, A.* FROM (
                SELECT 
                    P.PRODUCT_NO,
                    P.CATEGORY, P.PRODUCT_TITLE,
                    U.NICKNAME AS MAKER_NAME,
                    U.USER_ID AS MAKER_ID,
                    P.TARGET_AMOUNT,
                    NVL(P.CURRENT_AMOUNT, 0) AS CURRENT_AMOUNT, 
                    CASE WHEN P.TARGET_AMOUNT > 0 
                         THEN TRUNC((NVL(P.CURRENT_AMOUNT, 0) / P.TARGET_AMOUNT) * 100)
                         ELSE 0 END AS ACHIEVE_RATE,
                    TO_CHAR(P.FUND_START_DATE, 'YYYY-MM-DD') AS START_DATE,
                    TO_CHAR(P.FUND_END_DATE, 'YYYY-MM-DD') AS END_DATE,
                    P.PRODUCT_STATUS,
                    P.MODIFY_THUMBNAIL
                FROM PRODUCT P
                JOIN SELLER_PROFILE S ON P.SELLER_NO = S.SELLER_NO
                JOIN TB_USER U ON S.USER_NO = U.USER_NO
                <include refid="manageSearchCriteria"/>
                ORDER BY P.PRODUCT_NO DESC
            ) A
        )
        WHERE RNUM BETWEEN #{startRow} AND #{endRow}
    </select>

    <update id="updateProjectStatusInfo" parameterType="hashmap">
        UPDATE PRODUCT
        SET PRODUCT_STATUS = #{status}
        WHERE PRODUCT_NO = #{projectNo}
    </update>
    
    <update id="updateProjectSuccess">
    <![CDATA[
        UPDATE PRODUCT
        SET PRODUCT_STATUS = 'SUCCESS'
        WHERE PRODUCT_STATUS = 'OPEN'
          AND FUND_END_DATE < SYSDATE 
          AND NVL(CURRENT_AMOUNT, 0) >= TARGET_AMOUNT 
    ]]>
    </update>
    
    <update id="updateProjectFail">
    <![CDATA[
        UPDATE PRODUCT
        SET PRODUCT_STATUS = 'FAIL'
        WHERE PRODUCT_STATUS = 'OPEN'
          AND FUND_END_DATE < SYSDATE 
          AND NVL(CURRENT_AMOUNT, 0) < TARGET_AMOUNT 
    ]]>
    </update>

</mapper>